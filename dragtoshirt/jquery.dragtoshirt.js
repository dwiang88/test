// kw add content type to ajax requests and callbacks
// TODO: what happens when a sync call is made while async in progress?
function SpreadshirtAPI(a,b,c){var d=this;this.getShop=function(a,b){if(this.shopCache[a]!=null)return this.shopCache[a];var c=null;return $.ajax({type:"GET",async:typeof b!="undefined",cache:!0,url:this.createUrl(this.baseHttpUrl+"/shops/"+a),contentType:"application/xml",dataType:"xml",success:function(e){c=$(e).find("shop"),d.shopCache[a]=c,b&&b(c)}}),c},this.getProductType=function(a,b){if(this.productTypeCache[a]!=null)return this.productTypeCache[a];var c=null;return $.ajax({type:"GET",async:typeof b!="undefined",cache:!0,url:this.createUrl(this.shop.find("productTypes").attr("xlink:href")+"/"+a),dataType:"xml",success:function(e){c=$(e).find("productType"),d.productTypeCache[a]=c,b&&b(c)}}),c},this.createDesign=function(a,b){var c=null,d=null;$.ajax({type:"POST",async:!1,data:a,url:this.createUrl(this.shop.find("designs").attr("xlink:href")),contentType:"application/xml",dataType:"xml",complete:function(a){a.status==201&&(d=a.getResponseHeader("Location"))}});if(d!=null){var e=null;$.ajax({type:"GET",async:!1,cache:!0,url:this.createUrl(d),dataType:"xml",success:function(a){e=$(a).find("design")}});var f=e.children("resources").children("resource").attr("xlink:href");e!=null&&$.ajax({type:"PUT",async:!1,data:b,url:this.createUrl(f),beforeSend:function(a){a.setRequestHeader("Content-Type","image/png")},complete:function(a){c=d}})}return c},this.createProduct=function(a){var b=null;return $.ajax({type:"POST",async:!1,data:a,url:this.createUrl(this.shop.find("products").attr("xlink:href")),contentType:"application/xml",dataType:"xml",complete:function(a){a.status==201&&(b=a.getResponseHeader("Location"))}}),b},this.createBasketAndCheckout=function(a,b){var c=null,d=null,e=null;return $.ajax({type:"POST",async:!1,data:a,url:this.createUrl(this.shop.find("baskets").attr("xlink:href")),contentType:"application/xml",dataType:"xml",complete:function(a){a.status==201&&(c=a.getResponseHeader("Location"))}}),c!=null&&($.ajax({type:"POST",async:!1,data:b,url:this.createUrl(c+"/items"),contentType:"application/xml",dataType:"xml",complete:function(a){a.status==201&&(d=a.getResponseHeader("Location"))}}),d!=null&&$.ajax({type:"GET",async:!1,url:this.createUrl(c+"/checkout")+"&secure=true",dataType:"xml",success:function(a){var b=$(a).find("reference");b!=null&&(e=b.attr("xlink:href"))}})),e},this.getPrintType=function(a,b){if(this.printTypeCache[a]!=null)return this.printTypeCache[a];var c=null;return $.ajax({type:"GET",async:typeof b!="undefined",cache:!0,url:this.createUrl(this.shop.find("printTypes").attr("xlink:href")+"/"+a),dataType:"xml",success:function(e){c=$(e).find("printType"),d.printTypeCache[a]=c,b&&b(c)}}),c},this.getFontFamily=function(a){if(this.fontFamilyCache[a]!=null)return this.fontFamilyCache[a];var b=null;return $.ajax({type:"GET",async:!1,cache:!0,url:this.createUrl(this.shop.find("fontFamilies").attr("xlink:href")+"/"+a),dataType:"xml",success:function(a){b=$(a).find("fontFamily")}}),this.fontFamilyCache[a]=b,b},this.getCurrency=function(a,b){if(this.currencyCache[a]!=null)return this.currencyCache[a];var c=null;return $.ajax({type:"GET",async:typeof b!="undefined",cache:!0,url:this.createUrl(this.shop.find("currencies").attr("xlink:href")+"/"+a),dataType:"xml",success:function(e){c=$(e).find("currency"),d.currencyCache[a]=c,b&&b(c)}}),c},this.getCountry=function(a,b){if(this.countryCache[a]!=null)return this.countryCache[a];var c=null;return $.ajax({type:"GET",async:typeof b!="undefined",cache:!0,url:this.createUrl(this.shop.find("countries").attr("xlink:href")+"/"+a),dataType:"xml",success:function(e){c=$(e).find("country"),d.countryCache[a]=c,b&&b(c)}}),c},this.getDesign=function(a){if(this.designCache[a]!=null)return this.designCache[a];var b=null;return $.ajax({type:"GET",async:!1,cache:!0,url:this.createUrl(this.shop.find("designs").attr("xlink:href")+"/"+a),dataType:"xml",success:function(a){b=$(a).find("design")}}),this.designCache[a]=b,b},this.getMarketplaceDesigns=function(a,b,c){var d=null;return $.ajax({type:"GET",async:!1,cache:!0,url:this.createUrl(this.shop.find("designCategories").attr("xlink:href")+"/b1000000/designs?offset="+a+"&limit="+b+"&query="+c),dataType:"xml",success:function(a){d=$(a).find("designs")}}),d},this.getProductTypes=function(a,b,c,d){var e=null;return $.ajax({type:"GET",async:typeof d!="undefined",cache:!0,url:this.createUrl(this.shop.find("productTypes").attr("xlink:href")+"?offset="+a+"&limit="+b+"&fullData="+c),dataType:"xml",success:function(a){e=$(a).find("productTypes"),d&&d(e)}}),e},this.createUrl=function(a){return a=a.replace(/\?/g,"%3F"),a=a.replace(/\&/g,"%26"),a=a.replace(/\+/g,"%2B"),this.useProxy?this.useProxy+"?url="+a:a},this.baseHttpUrl="http://api.spreadshirt.net/api/v1",this.baseHttpsUrl="https://api.spreadshirt.net/api/v1",a=="na"&&(this.baseHttpUrl="http://api.spreadshirt.com/api/v1",this.baseHttpsUrl="https://api.spreadshirt.com/api/v1"),this.printTypeCache=new Array,this.productTypeCache=new Array,this.shopCache=new Array,this.designCache=new Array,this.currencyCache=new Array,this.countryCache=new Array,this.fontFamilyCache=new Array,this.useProxy=c==null?!0:c,this.useProxy=this.useProxy===!0?"/proxy.php":this.useProxy,this.shopId=b,this.load=function(){this.shop=this.getShop(b),this.currency=this.getCurrency(this.shop.children("currency").attr("id")),this.country=this.getCountry(this.shop.children("country").attr("id"))}}function Simplomat(){this.defaultSize=800,this.relativeScaleFactor=null,this.spreadshirtAPI=null,this.R=null,this.product=null,this.editAllowed=null,this.editMode=!1,this.width=null,this.height=null,this.offsetX=0,this.offsetY=0,this.selectionColor="#ff8c00",this.highlightColor="#fc0",this.textColor="#000",this.boxStrokeColor="#ccc",this.boxFillColor="#fff",this.boxFillDeselectedColor="#ccc",this.errorColor="#FF0000",this.allowedPrintTypeIds=new Array,this.printTypeMode="digi",this.printType=null,this.pixelAllowed=!1,this.initCallback=null,this.enableEditCallback=null,this.disableEditCallback=null,this.productTypeChangedCallback=null,this.appearanceChangedCallback=null,this.viewChangedCallback=null,this.sizeChangedCallback=null,this.priceChangedCallback=null,this.errorCallback=null,this.init=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){this.spreadshirtAPI=c,this.editAllowed=e,this.offsetX=k===undefined||k===null?0:k,this.offsetY=l===undefined||l===null?0:l,this.width=m===undefined||m===null?b:m,this.height=n===undefined||n===null?b:n;if(j===undefined||j===null)j="digi";j=="flock"?(this.printTypeMode="flock",this.allowedPrintTypeIds.push("2"),this.pixelAllowed=!1):j=="flex"?(this.printTypeMode="flex",this.allowedPrintTypeIds.push("14"),this.pixelAllowed=!1):(this.printTypeMode="digi",this.allowedPrintTypeIds.push("17"),this.allowedPrintTypeIds.push("19"),this.pixelAllowed=!0);var o=this.spreadshirtAPI.getPrintType(this.allowedPrintTypeIds[0]),p=Number(o.children("dpi").text()),q=new Array;return o.children("colors")!=null&&o.children("colors").children("color").each(function(){var a=$(this);q.push(new PrintColor(a.attr("id"),a.children("fill").text(),Number(a.children("price").children("vatIncluded").text())))}),this.printType=new PrintType(o.attr("id"),p,Number(o.children("price").children("vatIncluded").text()),PixelMMConverter.mmToPixel(Number(o.children("size").children("width").text()),p),PixelMMConverter.mmToPixel(Number(o.children("size").children("height").text()),p),q),this.R=Raphael(a,this.width,this.height),this.product=(new Product(this.offsetX,this.offsetY,b,this)).init(g,i,h),this.relativeScaleFactor=this.relativeScaleFactor||b/this.defaultSize,this.initCustomFunctions(),d&&this.enableEdit(),f!=null&&this.product.currentView.addDesign(f,null,!0),this},this.enableEdit=function(){this.editMode==0&&(this.editMode=!0,this.product.currentView.enableEdit(),this.enableEditCustomFunctions(),this.R.safari())},this.disableEdit=function(){this.editMode==1&&(this.editMode=!1,this.product.currentView.disableEdit(),this.disableEditCustomFunctions(),this.R.safari())},this.initCustomFunctions=function(){this.initCallback!==undefined&&this.initCallback!==null&&this.initCallback()},this.enableEditCustomFunctions=function(){this.enableEditCallback!==undefined&&this.enableEditCallback!==null&&this.enableEditCallback()},this.disableEditCustomFunctions=function(){this.disableEditCallback!==undefined&&this.disableEditCallback!==null&&this.disableEditCallback()},this.productTypeChangedCustomFunctions=function(){this.productTypeChangedCallback!==undefined&&this.productTypeChangedCallback!==null&&this.productTypeChangedCallback()},this.appearanceChangedCustomFunctions=function(){this.appearanceChangedCallback!==undefined&&this.appearanceChangedCallback!==null&&this.appearanceChangedCallback()},this.viewChangedCustomFunctions=function(){this.viewChangedCallback!==undefined&&this.viewChangedCallback!==null&&this.viewChangedCallback()},this.sizeChangedCustomFunctions=function(){this.sizeChangedCallback!==undefined&&this.sizeChangedCallback!==null&&this.sizeChangedCallback()},this.priceChangedCustomFunctions=function(){this.priceChangedCallback!==undefined&&this.priceChangedCallback!==null&&this.priceChangedCallback()},this.errorCustomFunctions=function(a,b){this.errorCallback!==undefined&&this.errorCallback!==null&&this.errorCallback(a,b)},this.createProduct=function(){return this.uploadDesigns()?null:(this.product.href==null&&(this.product.href=this.spreadshirtAPI.createProduct(this.getProductXML())),this.product.href)},this.createBasketAndCheckout=function(){if(this.product.sizeId===undefined||this.product.sizeId===null){this.errorCustomFunctions("no_size","Please select a product size!");return}if(this.product.appearanceId===undefined||this.product.appearanceId===null){this.errorCustomFunctions("no_appearance","Please select a product color!");return}if(this.product.href===undefined||this.product.href===null){this.errorCustomFunctions("product_not_created","Product not available at server!");return}return this.spreadshirtAPI.createBasketAndCheckout(this.getBasketXML(),this.getBasketItemXML())},this.createProductAndCheckout=function(){if(this.product.sizeId===undefined||this.product.sizeId===null){this.errorCustomFunctions("no_size","Please select a product size!");return}this.createProduct();if(this.product.href!=null){var a=this.createBasketAndCheckout();a!=null&&(window.location.href=a)}},this.uploadDesigns=function(){var a=!1,b=new Array;for(var c in this.product.views)for(var d in this.product.views[c].designs){var e=this.product.views[c].designs[d];e.id==null&&b.push(e)}for(c in b){var f=this.spreadshirtAPI.createDesign(this.getDesignXML(),this.getDesignUploadXML(b[c].src));f!=null?b[c].id=f.substring(f.lastIndexOf("/")+1):a=!0}return a},this.getProductXML=function(){var a='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<product xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://api.spreadshirt.net">\n  <productType id="'+this.product.productTypeId+'"/>\n'+'  <appearance id="'+this.product.appearanceId+'"/>\n'+"  <restrictions>\n"+"     <freeColorSelection>false</freeColorSelection>\n"+"     <example>false</example>\n"+"  </restrictions>\n"+"  <configurations>\n";for(var b in this.product.views){var c=this.product.views[b];for(var d in c.designs){var e=c.designs[d],f="",g="";for(var h in e.colors)h>0&&(f+=" ",g+=" "),f+=e.colors[h],g+=e.printColorIds[h];var i=Rounder.round(PixelMMConverter.pixelToMM((e.x-this.offsetX)*c.width/this.product.size-c.offsetX),this.printType.dpi),j=Rounder.round(PixelMMConverter.pixelToMM((e.y-this.offsetY)*c.height/this.product.size-c.offsetY),this.printType.dpi),k=Rounder.round(PixelMMConverter.pixelToMM(e.width/2*c.width/this.product.size),this.printType.dpi),l=Rounder.round(PixelMMConverter.pixelToMM(e.height/2*c.height/this.product.size),this.printType.dpi),m=Rounder.round(PixelMMConverter.pixelToMM(e.width*c.width/this.product.size),this.printType.dpi),n=Rounder.round(PixelMMConverter.pixelToMM(e.height*c.height/this.product.size),this.printType.dpi);a+='    <configuration type="design">\n       <printArea id="'+c.printAreaId+'"/>\n'+'        <printType id="'+this.product.getAppearance(this.product.appearanceId).printTypeId+'"/>\n'+'        <offset unit="mm">\n'+"            <x>"+i+"</x>\n"+"            <y>"+j+"</y>\n"+"        </offset>\n"+'        <content dpi="25.4" unit="mm">\n'+"            <svg>\n"+'                <image transform="'+(e.angle!=0?"rotate("+e.angle+","+k+","+l+")":"")+'" \n'+'                       width="'+m+'" \n'+'                       height="'+n+'" \n'+'                       printColorRGBs="'+f+'" \n'+'                       printColorIds="'+g+'" \n'+'                       designId="'+e.id+'"/>\n'+"                <!--"+e.src+"-->\n"+"            </svg>\n"+"        </content>\n"+"        <restrictions>\n"+"            <changeable>false</changeable>\n"+"        </restrictions>\n"+"    </configuration>\n"}for(var d in c.texts){var o=c.texts[d],p=PixelMMConverter.pixelToMM(c.width,this.printType.dpi)/this.product.size,q=this.R.getFont(o.font.name),r=Number(q.face.ascent),s=Math.abs(Number(q.face.descent)),t=r/(r+s),u=(o.x-c.boundary.x)*p,v=(o.y+o.fontSize*t-c.boundary.y)*p;a+='   <configuration type="text">\n      <printArea id="'+c.printAreaId+'"/>\n'+'      <printType id="'+this.product.getAppearance(this.product.appearanceId).printTypeId+'"/>\n'+'      <offset unit="mm">\n'+"         <x>0.0</x>\n"+"         <y>0.0</y>\n"+"      </offset>\n"+'      <content dpi="25.4" unit="mm">\n'+"         <svg>\n"+'            <text transform="" '+'                  fontId="'+o.font.id+'" '+'                  fontFamilyId="'+o.font.familyId+'" '+'                  font-family="'+o.font.name+'" '+'                  font-style="'+o.font.style+'" '+'                  font-weight="'+o.font.weight+'" '+'                  font-size="'+o.fontSize*p+'" '+'                  text-anchor="'+o.textAnchor+'" '+'                  x="'+u+'" '+'                  y="'+v+'" '+'                  fill="'+o.color+'" '+'                  printColorId="'+o.printColorId+'">';for(var h in o.textLines){var w=o.textLines[h],u=(w.x-c.boundary.x)*p,v=(w.y+w.getFontSize()*t-c.boundary.y)*p;a+='<tspan transform=""     fontId="'+w.getFont().id+'" '+'    fontFamilyId="'+w.getFont().familyId+'" '+'    font-family="'+w.getFont().name+'" '+'    font-style="'+w.getFont().style+'" '+'    font-weight="'+w.getFont().weight+'" '+'    font-size="'+w.getFontSize()*p+'" '+'    text-anchor="'+w.getTextAnchor()+'" '+'    x="'+u+'" '+'    y="'+v+'" '+'    fill="'+w.getColor()+'" '+'    printColorId="'+w.getPrintColorId()+'">'+w.textString+"</tspan>"}a+="</text>\n         </svg>\n      </content>\n   </configuration>\n"}}return a+="  </configurations>\n</product>\n",a},this.getBasketXML=function(){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<basket xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://api.spreadshirt.net">\n   <shop id="'+this.spreadshirtAPI.shopId+'"/>\n'+"</basket>"},this.getBasketItemXML=function(){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<basketItem xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://api.spreadshirt.net">\n   <shop id="'+this.spreadshirtAPI.shopId+'"/>\n'+"   <description>my shop shirt</description>\n"+"   <quantity>1</quantity>\n"+'   <element type="sprd:product" xlink:href="'+this.product.href+'">\n'+"      <properties>\n"+'         <property key="appearance">'+this.product.appearanceId+"</property>\n"+'         <property key="size">'+this.product.sizeId+"</property>\n"+"      </properties>\n"+"   </element>\n"+"</basketItem>"},this.getDesignXML=function(){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<design xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://api.spreadshirt.net">\n  <name>xxx</name>\n  <description>zzz</description>\n</design>'},this.getDesignUploadXML=function(a){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<ref xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://api.spreadshirt.net" xlink:href="'+a+'">'}}function ProductPartsFactory(a,b,c){this.product=a,this.size=b,this.simplomat=c,this.createAppearances=function(a){var b=new Array,c=this.simplomat.allowedPrintTypeIds;return a.children("appearances").children("appearance").each(function(){var a=$(this),d=null;a.children("printTypes").children("printType").each(function(){var a=$(this).attr("id");for(key in c)if(a===c[key]){d=c[key];break}}),d!=null&&b.push(new Appearance(a.attr("id"),a.children("name")!=null?a.children("name").text():"",a.children("description")!=null?a.children("description").text():"",a.children("resources").children("resource").attr("xlink:href"),d))}),b},this.createViews=function(a){var c=new Array,d=this.simplomat.allowedPrintTypeIds,e=this.product,f=this.simplomat;return a.children("views").children("view").each(function(){var g=$(this),h=null,i=g.children("viewMaps").children("viewMap").children("printArea").attr("id");a.children("printAreas").children("printArea").each(function(){var a=$(this);if(h==null&&i!=null&&a.attr("id")===i){var b=!1;a.children("restrictions").children("excludedPrintTypes").children("excludedPrintType").each(function(){var a=$(this);for(key in d)d[key]===a.attr("id")&&(b=!0)}),b||(h=a)}}),h!=null&&c.push(new View(g.attr("id"),PixelMMConverter.mmToPixel(Number(g.children("size").children("width").text()),f.printType.dpi),PixelMMConverter.mmToPixel(Number(g.children("size").children("height").text()),f.printType.dpi),PixelMMConverter.mmToPixel(Number(g.children("viewMaps").children("viewMap").children("offset").children("x").text()),f.printType.dpi),PixelMMConverter.mmToPixel(Number(g.children("viewMaps").children("viewMap").children("offset").children("y").text()),f.printType.dpi),h.attr("id"),PixelMMConverter.mmToPixel(Number(h.children("boundary").children("size").children("width").text()),f.printType.dpi),PixelMMConverter.mmToPixel(Number(h.children("boundary").children("size").children("height").text()),f.printType.dpi),g.children("perspective").text(),b/PixelMMConverter.mmToPixel(Number(g.children("size").children("width").text()),f.printType.dpi),e,f))}),c},this.createSizes=function(a){var b=new Array;return a.children("sizes").children("size").each(function(){var a=$(this);b.push(new Size(a.attr("id"),a.children("name").text()))}),b},this.createAvailableSizes=function(a,b){var c=new Object;for(var d=0;d<b.length;d++)c[b[d].id]=new Array;return a.children("stockStates").children("stockState").each(function(){var a=$(this),b=a.children("appearance").attr("id"),d=a.children("size").attr("id"),e=a.children("available").text(),f=c[b];e=="true"&&f!=null&&f.push(d)}),c}}function Product(a,b,c,d){this.simplomat=d,this.simplomat.product=this,this.productPartsFactory=new ProductPartsFactory(this,c,d),this.href=null,this.image=d.R.image("img/empty.gif",a,b,c,c),this.image.simplomat=d,this.image.product=this,this.image.click(function(a){this.product.currentView.currentDesign!=null&&a.clientX>=this.product.currentView.boundary.x&&a.clientX<=this.product.currentView.boundary.x+this.product.currentView.boundary.width&&a.clientY>=this.product.currentView.boundary.y&&a.clientY<=this.product.currentView.boundary.y+this.product.currentView.boundary.height&&(this.product.currentView.currentDesign.img[0].hide(),this.product.currentView.currentDesign=null)}),this.offsetX=a,this.offsetY=b,this.size=c,this.views=new Array,this.appearances=new Array,this.sizes=new Array,this.availableSizes=new Object,this.productTypeId=null,this.appearanceId=null,this.sizeId=null,this.viewId=null,this.defaultAppearanceId=null,this.defaultViewId=null,this.imageUrl=null,this.currentView=null,this.priceFormatter=new PriceFormatter(this.simplomat.spreadshirtAPI.currency.children("pattern").text(),this.simplomat.spreadshirtAPI.currency.children("decimalCount").text(),this.simplomat.spreadshirtAPI.country.children("decimalPoint").text(),this.simplomat.spreadshirtAPI.country.children("thousandsSeparator").text()),this.priceSymbol=this.simplomat.spreadshirtAPI.currency.children("symbol").text(),this.price=null,this.init=function(a,b,c,d,e,f){this.productTypeId=a;var g=this.simplomat.spreadshirtAPI.getProductType(a);this.imageUrl=g.children("resources").children("resource").attr("xlink:href"),this.defaultAppearanceId=g.find("defaultAppearance")==null?null:g.find("defaultAppearance").attr("id"),this.defaultViewId=g.find("defaultView")==null?null:g.find("defaultView").attr("id"),this.appearanceId=c===null||c===undefined?this.defaultAppearanceId:c,this.viewId=b===null||b===undefined?this.defaultViewId:b,this.price=Number(g.children("price").children("vatIncluded").text()),this.appearances=this.productPartsFactory.createAppearances(g),this.views=this.productPartsFactory.createViews(g),this.sizes=this.productPartsFactory.createSizes(g),this.availableSizes=this.productPartsFactory.createAvailableSizes(g,this.appearances);for(var h=0;h<this.appearances.length;h++)if(this.appearances[h].name===e){this.appearanceId=this.appearances[h].id;break}if(this.appearanceId===this.defaultAppearanceId){var i=!1;for(var h=0;h<this.appearances.length;h++)this.appearances[h].id==this.appearanceId&&(i=!0);i||(this.appearanceId=this.appearances[0].id)}for(var h=0;h<this.views.length;h++)if(this.views[h].perspective===d){this.viewId=this.views[h].id;break}if(this.viewId===this.defaultViewId){var j=!1;for(var h=0;h<this.views.length;h++)this.views[h].id==this.viewId&&(j=!0);j||(this.viewId=this.views[0].id)}for(var h=0;h<this.sizes.length;h++)if(this.sizes[h].name===f){this.sizeId=this.sizes[h].id;break}return this.changeView(this.viewId),this},this.getView=function(a){if(this.viewId!=null)for(var b=0;b<this.views.length;b++)if(this.views[b].id===a)return this.views[b];return null},this.getAppearance=function(a){for(var b=0;b<this.appearances.length;b++)if(this.appearances[b].id===a)return this.appearances[b];return null},this.getSize=function(a){for(var b=0;b<this.sizes.length;b++)if(this.sizes[b].id===a)return this.sizes[b];return null},this.getAvailableSizes=function(){return this.availableSizes[this.appearanceId]},this.changeProductType=function(a){var b=this.views,c=this.currentView.perspective,d=this.getAppearance(this.appearanceId).name,e=this.sizeId!=null?this.getSize(this.sizeId).name:"",f=this.simplomat.spreadshirtAPI.getProductType(a),g=this.productPartsFactory.createViews(f),h=this.productPartsFactory.createAppearances(f),i=this.productPartsFactory.createSizes(f);if(g.length>0&&h.length>0&&i.length>0){for(var j=0;j<this.views.length;j++)this.views[j].detach();this.views=new Array,this.appearances=new Array,this.sizes=new Array,this.availableSizes=new Array,this.productTypeId=null,this.appearanceId=null,this.sizeId=null,this.viewId=null,this.defaultAppearanceId=null,this.defaultViewId=null,this.imageUrl=null,this.currentView=null,this.init(a,null,null,c,d,e);for(var j=0;j<b.length;j++){var c=b[j].perspective,k=this.currentView;for(var l=0;l<this.views.length;l++)if(this.views[l].perspective===c){k=this.views[l];break}for(var m=0;m<b[j].designs.length;m++)b[j].designs[m].changeView(k);for(var m=0;m<b[j].texts.length;m++)b[j].texts[m].changeView(k)}this.simplomat.productTypeChangedCustomFunctions()}},this.changeView=function(a){this.getView(a)!=null&&(a==null&&(a=this.defaultViewId),this.currentView!=null&&this.currentView.hide(),this.currentView=this.getView(a),this.viewId=a,this.currentView.show(),this.simplomat.viewChangedCustomFunctions())},this.changeAppearance=function(a){this.getAppearance(a)!=null&&(this.appearanceId=a,this.image.attr({src:this.createViewImageUrl(this.viewId,this.appearanceId,this.simplomat.defaultSize)}),this.simplomat.appearanceChangedCustomFunctions(),this.simplomat.priceChangedCustomFunctions())},this.changeSize=function(a){if(this.getSize(a)!=null)for(var b=0;b<this.availableSizes[this.appearanceId].length;b++)if(this.availableSizes[this.appearanceId][b]==a){this.sizeId=a,this.simplomat.sizeChangedCustomFunctions();break}},this.removeAllDesigns=function(){for(var a in this.views){for(var b in this.views[a].designs)this.views[a].designs[b].remove();this.views[a].designs=new Array,this.views[a].currentDesign=null}this.simplomat.R.safari()},this.removeAllText=function(){for(var a in this.views){for(var b in this.views[a].texts)this.views[a].texts[b].remove();this.views[a].texts=new Array}this.simplomat.R.safari()},this.removeAll=function(){this.removeAllDesigns(),this.removeAllText()},this.createViewImageUrl=function(a,b,c){return this.imageUrl.substr(0,this.imageUrl.indexOf("/views"))+"/views/"+a+"/appearances/"+b+",width="+c+",height="+c},this.getFullPrice=function(){var a=this.price;for(var b=0;b<this.views.length;b++){for(var c=0;c<this.views[b].designs.length;c++){var d=this.views[b].designs[c];a+=d.price,a+=this.simplomat.printType.price;if(d.printColorIds!==undefined&&d.printColorIds!=null)for(var e=0;e<d.printColorIds.length;e++){var f=d.printColorIds[e],g=this.simplomat.printType.getPrintColorById(f);g!=null&&(a+=g.price)}}for(var c=0;c<this.views[b].texts.length;c++){var h=this.views[b].texts[c];a+=this.simplomat.printType.price;if(h.printColorId!=undefined&&h.printColorId!=null){var g=this.simplomat.printType.getPrintColorById(h.printColorId);g!=null&&(a+=g.price)}}}return a},this.getFormatedPrice=function(){return this.priceFormatter.formatPrice(this.getFullPrice(),this.priceSymbol)}}function Appearance(a,b,c,d,e){this.id=a,this.name=b,this.description=c,this.imageUrl=d,this.printTypeId=e}function Size(a,b){this.id=a,this.name=b}function View(a,b,c,d,e,f,g,h,i,j,k,l){this.simplomat=l,this.product=k,this.designs=new Array,this.texts=new Array,this.currentDesign=null,this.id=a,this.width=b,this.height=c,this.offsetX=d,this.offsetY=e,this.printAreaId=f,this.printAreaWidth=g,this.printAreaHeight=h,this.perspective=i,this.scaleFactor=j,this.boundary=new Boundary(this.product.offsetX+this.offsetX*this.scaleFactor,this.product.offsetY+this.offsetY*this.scaleFactor,this.printAreaWidth*this.scaleFactor,this.printAreaHeight*this.scaleFactor,l),this.enableEdit=function(){this.boundary.show();for(var a in this.designs)this.designs[a].enableEdit();for(var a in this.texts)this.texts[a].enableEdit()},this.disableEdit=function(){this.boundary.hide();for(var a in this.designs)this.designs[a].disableEdit();for(var a in this.texts)this.texts[a].disableEdit()},this.show=function(){this.product.image.attr({src:this.product.createViewImageUrl(this.id,this.product.appearanceId,this.simplomat.defaultSize)});for(var a in this.designs)this.designs[a].show();for(var a in this.texts)this.texts[a].show();this.simplomat.editMode&&this.boundary.show()},this.hide=function(){for(var a in this.designs)this.designs[a].hide();for(var a in this.texts)this.texts[a].hide();this.boundary.hide()},this.detachFromCanvas=function(){this.boundary.detachFromCanvas()},this.detach=function(){this.detachFromCanvas(),this.product=null,this.simplomat=null},this.addDesign=function(a,b,c,d,e){if(this.simplomat.editMode||c){var f=new Image;f.simplomat=this.simplomat,f.currentView=this,f.originalWidth=undefined,f.originalHeight=undefined,f.minimumScale=undefined,f.enlargable=undefined;var g=!1;if(b!==undefined&&b!=null){var h=this.simplomat.spreadshirtAPI.getDesign(b);f.originalWidth=PixelMMConverter.mmToPixel(h.children("size").children("width").text(),this.simplomat.printType.dpi),f.originalHeight=PixelMMConverter.mmToPixel(h.children("size").children("height").text(),this.simplomat.printType.dpi);var i=h.children("colors").children("color").length>0;i?f.minimumScale=Number(h.children("restrictions").children("minimumScale").text())/100:f.minimumScale=undefined,f.enlargable=i,f.colors=new Array,f.printColorIds=new Array;var j=this.simplomat.printType,k=0;h.children("colors").children("color").each(function(){var a=$(this).children("default").text();d!=null&&(a=d[k]);var b=j.getPrintColor(a);b==null?f.colors.push(a):(f.printColorIds.push(b.id),f.colors.push(b.hex)),k++}),f.price=h.find("vatIncluded")==null?0:Number(h.find("vatIncluded").text());var l=f.originalWidth*this.scaleFactor,m=f.originalHeight*this.scaleFactor,n=0,o=0,p=600;if(l>p||m>p){var q=l>m?l:m,r=p/q;l*=r,m*=r}l%50>0&&(n=50-l%50,l+=n),m%50>0&&(o=50-m%50,m+=o),a=l>m?h.children("resources").children("resource").attr("xlink:href")+"?width="+l+"&backgroundColor=none":h.children("resources").children("resource").attr("xlink:href")+"?height="+m+"&backgroundColor=none";for(var k=0;k<f.colors.length;k++)a+="&colors["+k+"]="+f.colors[k].substr(1);f.designId=b;var s=this.simplomat;h.children("printTypes").children("printType").each(function(){var a=$(this);for(k in s.allowedPrintTypeIds)if(a.attr("id")===s.allowedPrintTypeIds[k]){g=!0;break}})}else f.price=0,f.designId=null,this.simplomat.printTypeMode=="digi"&&(g=!0);if(g){function t(a,b){return function(){return b.apply(a,arguments)}}function u(){var a=(this.originalWidth===undefined?this.width:this.originalWidth)*this.currentView.scaleFactor,b=(this.originalHeight===undefined?this.height:this.originalHeight)*this.currentView.scaleFactor,c=1;a>this.currentView.boundary.width&&(c=this.currentView.boundary.width/a),b*c>this.currentView.boundary.height&&(c=this.currentView.boundary.height/b);var d=this.currentView.boundary.x,f=this.currentView.boundary.y,g=a*c,h=b*c,i=null,j=null;this.currentView.boundary.width-a*c>0&&(d+=(this.currentView.boundary.width-a*c)/2);if(this.currentView.boundary.height-b*c>0){var k=this.currentView.boundary.height/6;this.currentView.boundary.height-(h+k)<0&&(k+=this.currentView.boundary.height-(h+k)),f+=k}g===this.currentView.boundary.width||h===this.currentView.boundary.height?(i=.8,j=.8):(i=1,j=1),this.currentView.currentDesign!=null&&this.currentView.currentDesign.img[0].hide(),this.currentView.currentDesign=new Design(this.designId,this.src,d,f,g,h,0,i,j,a,b,c,this.minimumScale,this.enlargable,this.colors,this.printColorIds,this.price,this.currentView,this.simplomat),this.currentView.designs.push(this.currentView.currentDesign),e!==undefined&&e!=null&&e.apply(this.currentView.currentDesign,[]),this.simplomat.priceChangedCustomFunctions()}f.onload=t(f,u),f.src=a}}},this.addDesignById=function(a,b){this.addDesign(null,a,b)},this.getViewScale=function(){return PixelMMConverter.pixelToMM(this.width,this.simplomat.printType.dpi)/this.product.size},this.addText=function(a,b,c,d,e,f,g){if(this.simplomat.editMode||f){var h=this.simplomat.spreadshirtAPI.getFontFamily(b);if(h!=null){var i=null;h.children("fonts").children("font").each(function(){var a=$(this);a.attr("id")==c&&(i=a)});if(i!=null){var j=this.boundary.x,k=this.boundary.y,l=this.getViewScale(),m=new Font(c,b,i.children("name").text(),i.children("style").text(),i.children("weight").text(),i.children("minimalSize").text()),n=this.simplomat.printType.getPrintColor(e),o=new Text(m,d/l,e,n==null?null:n.id,j,k,"start",this,this.simplomat);this.texts.push(o),o.addTextLine(a,null,null,null,null,f,g)}}}return null},this.addTextAndLayout=function(a,b,c,d,e,f,g,h,i){var j=this.simplomat.spreadshirtAPI.getFontFamily(d);if(j!=null){var k=null;j.children("fonts").children("font").each(function(){var a=$(this);a.attr("id")==e&&(k=a)});if(k!=null){var l=this.boundary.width*c/100,m=PixelMMConverter.pixelToMM(this.width,this.simplomat.printType.dpi)/this.product.size,n=new Font(e,d,k.children("name").text(),k.children("style").text(),k.children("weight").text(),k.children("minimalSize").text()),o=a.split(" "),p=new Array;for(var q=0;q<o.length;q++){var r=$.trim(o[q]);r!==""&&p.push(r)}var s=new Array,t=null,u=new Text(n,f/m,g,null,5e3,5e3,"start",this,this.simplomat);for(var q=0;q<p.length;q++){var v=new TextLine(p[q],null,null,null,null,5e3,5e3,null,u,this.simplomat);s.push(v.getBoundary().width),v.remove()}var w=new TextLine("_",null,null,null,null,5e3,5e3,null,u,this.simplomat);t=w.getBoundary().width,w.remove();var x=null,y=null,z=!1;do{z=!1;var A=new Array,B=new Array,C="",D=0,E=!1;for(var q=0;q<p.length;q++)D>0&&(D+=t),D+=s[q],D<=l?(C!=""&&(C+=" "),C+=p[q]):(A.push(C),B.push(D),C=p[q],D=s[q]);E||(A.push(C),B.push(D));var F=l;for(var q=0;q<B.length;q++)(l-B[q])/l>.2&&(F=l*.95);y===null?(y=A,x=B,F!=l&&(z=!0,l=F)):y.length===A.length&&F!=l&&(y=A,x=B,z=!0,l=F)}while(z);this.addText(y,d,e,f,g,h,i)}}}}function Boundary(a,b,c,d,e){this.simplomat=e,this.x=a,this.y=b,this.width=c,this.height=d,this.rect=this.simplomat.R.rect(this.x,this.y,this.width,this.height),this.rect.attr({stroke:this.simplomat.boxStrokeColor}),this.rect.insertAfter(this.simplomat.product.image),this.show=function(){this.rect.show(),this.rect.animate({scale:1}),this.simplomat.R.safari()},this.hide=
function(){this.rect.hide(),this.simplomat.R.safari()},this.detachFromCanvas=function(){this.rect.remove(),this.simplomat.R.safari()},this.detach=function(){this.detachFromCanvas(),this.simplomat=null},this.hide()}function Design(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){this.simplomat=s,this.view=r,this.id=a===undefined?null:a,this.src=b,this.angle=g,this.zoomX=h,this.zoomY=i,this.originalWidth=j,this.originalHeight=k,this.originalScale=l,this.minimumScale=m===undefined?0:m,this.enlargable=n!==undefined,this.colors=o,this.printColorIds=p,this.price=q,this.error=!1,this.horizontalAlignment="center",this.verticalAlignment="center",this.img=this.simplomat.R.set(),this.img.push(this.simplomat.R.rect(c,d,e,f).attr({stroke:this.simplomat.selectionColor,"stroke-dasharray":"- "}),this.simplomat.R.image(this.src,c,d,e,f)),this.img.scale(this.zoomX,this.zoomY,c+e/2,d),this.img.simplomat=s,this.img[1].design=this,this.img[1].selectionRect=this.img[0],this.img[1].drag(function(a,b){if(this.dragging){var c=a-this.odx,d=b-this.ody;this.design.moveByDelta(c,d),this.odx=a,this.ody=b}},function(){this.dragging&&(this.design.view.currentDesign!=null&&this.design.view.currentDesign.img[0].hide(),this.design.view.currentDesign=this.design,this.design.img[0].show(),this.design.img[0].animate({x:this.design.img[0].attr("x")}),this.design.simplomat.R.safari(),this.ox=this.attr("x"),this.oy=this.attr("y"),this.odx=0,this.ody=0)},function(){this.dragging&&this.design.finalizeAction()}),this.simplomat.editMode?(this.img[1].attr({cursor:"move"}),this.img[1].dragging=!0):this.img[0].hide(),this.x=this.img[1].attr("x"),this.y=this.img[1].attr("y"),this.width=this.img[1].attr("width"),this.height=this.img[1].attr("height"),this.show=function(){this.view.currentDesign==this&&this.simplomat.editMode&&this.img[0].show(),this.img[1].show(),this.img[0].animate({x:this.img[0].attr("x")}),this.img[1].animate({x:this.img[1].attr("x")}),this.simplomat.R.safari()},this.hide=function(){this.img[0].hide(),this.img[1].hide(),this.simplomat.R.safari()},this.enableEdit=function(){this.view.currentDesign==this&&this.img[0].show(),this.img[1].attr({cursor:"move"}),this.img[1].dragging=!0},this.disableEdit=function(){this.img[0].hide(),this.img[1].attr({cursor:"auto"}),this.img[1].dragging=!1},this.zoom=function(a){if(a>0){var b=this.getBoundary(a);this.enlargable?b.width<=this.view.boundary.width&&b.height<=this.view.boundary.height&&(this.zoomX+=a,this.zoomY+=a):this.zoomX+a<=1?b.width<=this.view.boundary.width&&b.height<=this.view.boundary.height&&(this.zoomX+=a,this.zoomY+=a):(this.zoomX=1,this.zoomY=1)}else{var c=this.minimumScale>0?this.minimumScale:.1;this.zoomX+a>=c&&(this.zoomX+=a,this.zoomY+=a)}this.img.scale(this.zoomX,this.zoomY),this.finalizeAction(),this.simplomat.R.safari()},this.rotate=function(a){Math.abs(this.angle)==360&&(this.angle=0),this.angle+=a,this.img.rotate(this.angle,!0),this.finalizeAction(),this.simplomat.R.safari()},this.moveToPositionRelativeTo=function(a,b,c,d){var e=a.getBoundary(),f=this.getBoundary(),g=this.x,h=this.y;if(b=="above")h=e.y-d-f.height;else if(b="below")h=e.y+e.height+d;c=="left"?g=e.x:c=="center"?g=e.x+e.width/2-f.width/2:c=="right"&&(g=e.x+e.width-f.width),this.moveToPosition(g,h)},this.moveToPosition=function(a,b){var c=a-this.x,d=b-this.y;this.moveByDelta(c,d)},this.moveToRelativePosition=function(a,b){var c=this.getBoundary(),d=this.view.boundary.x+this.view.boundary.width*a/100-c.width/2,e=this.view.boundary.y+this.view.boundary.height*b/100-c.height/2;this.moveToPosition(d,e)},this.moveByDelta=function(a,b){this.img[0].translate(a,b),this.img[1].translate(a,b),this.x+=a,this.y+=b},this.remove=function(){this.img.remove();var a=this;this.view.designs=$.grep(this.view.designs,function(b){return b!=a}),this.view.currentDesign=null,this.simplomat.R.safari(),this.simplomat.priceChangedCustomFunctions()},this.finalizeAction=function(){var a=!1,b=this.getBoundary();b.x<this.view.boundary.x&&(a=!0),b.x>this.view.boundary.x+this.view.boundary.width-b.width&&(a=!0),b.y<this.view.boundary.y&&(a=!0),b.y>this.view.boundary.y+this.view.boundary.height-b.height&&(a=!0);var c=this.view.scaleFactor*this.simplomat.printType.width,d=this.view.scaleFactor*this.simplomat.printType.height;b.width>c&&(a=!0),b.height>d&&(a=!0),this.img[0].attr("x",this.img[1].attr("x")),this.img[0].attr("y",this.img[1].attr("y")),this.x=this.img[1].attr("x"),this.y=this.img[1].attr("y"),this.width=this.img[1].attr("width"),this.height=this.img[1].attr("height"),a?this.img[0].attr("stroke",this.simplomat.errorColor):this.img[0].attr("stroke",this.simplomat.selectionColor),this.error=a;var e=b.x-this.view.boundary.x,f=this.view.boundary.x+this.view.boundary.width-(b.x+b.width),g=b.y-this.view.boundary.y,h=this.view.boundary.y+this.view.boundary.height-(b.y+b.height);e-10<f&&e+10>f?this.horizontalAlignment="center":e<f?this.horizontalAlignment="left":this.horizontalAlignment="right",g-10<h&&g+10>h?this.verticalAlignment="center":g<h?this.verticalAlignment="top":this.verticalAlignment="bottom",this.simplomat.R.safari()},this.getBoundary=function(a){var b=this.img[1].attr("x"),c=this.img[1].attr("y"),d=this.img[1].attr("width"),e=this.img[1].attr("height"),f=b+d/2,g=c+e/2,h=Math.PI/180*(+this.angle||0),i=new Array,j=new Array;i[0]=f+Math.cos(h)*(b-f)-Math.sin(h)*(c-g),j[0]=g+Math.sin(h)*(b-f)+Math.cos(h)*(c-g),i[1]=f+Math.cos(h)*(b+d-f)-Math.sin(h)*(c-g),j[1]=g+Math.sin(h)*(b+d-f)+Math.cos(h)*(c-g),i[2]=f+Math.cos(h)*(b-f)-Math.sin(h)*(c+e-g),j[2]=g+Math.sin(h)*(b-f)+Math.cos(h)*(c+e-g),i[3]=f+Math.cos(h)*(b+d-f)-Math.sin(h)*(c+e-g),j[3]=g+Math.sin(h)*(b+d-f)+Math.cos(h)*(c+e-g);var k=i[0],l=j[0],m=i[0],n=j[0];for(var o=0;o<i.length;o++)i[o]<k&&(k=i[o]),i[o]>m&&(m=i[o]),j[o]<l&&(l=j[o]),j[o]>n&&(n=j[o]);var p=new Object;return p.x=Math.round(k*100)/100,p.y=Math.round(l*100)/100,p.width=Math.round((m-k)*100)/100,p.height=Math.round((n-l)*100)/100,p},this.detachFromCanvas=function(){this.img.remove(),this.simplomat.R.safari()},this.detach=function(){this.detachFromCanvas(),this.simplomat=null,this.view=null},this.changeView=function(a){var b=this.getBoundary(),c=this.view.boundary,d=a.boundary,e=b.x-c.x,f=c.x+c.width-(b.x+b.width),g=b.y-c.y,h=c.y+c.height-(b.y+b.height),i=d.width/c.width,j=d.height/c.height;a.currentDesign=this.view.currentDesign,this.view=a,this.view.designs.push(this),this.view!=this.view.product.currentView&&this.hide();var k=0,l=0;this.horizontalAlignment=="center"?k=d.width/2+d.x-b.width/2:this.horizontalAlignment=="left"?k=d.x+e*i:k=d.x+d.width-f*i-b.width,this.verticalAlignment=="center"?l=d.height/2+d.y-b.height/2:this.verticalAlignment=="top"?l=d.y+g*j:l=d.y+d.height-h*j-b.height;if(this.angle!=0){var m=this.x+this.width/2,n=this.y+this.height/2,o=Math.PI/180*(+this.angle||0),p=m+Math.cos(o)*(this.x-m)-Math.sin(o)*(this.y-n),q=n+Math.sin(o)*(this.x-m)+Math.cos(o)*(this.y-n),r=k-b.x,s=l-b.y;p+=r,q+=s,m+=r,n+=s,o=Math.PI/180*(-this.angle||0),k=m+Math.cos(o)*(p-m)-Math.sin(o)*(q-n),l=n+Math.sin(o)*(p-m)+Math.cos(o)*(q-n)}this.img[0].attr("x",k),this.img[1].attr("x",k),this.x=k,this.img[0].attr("y",l),this.img[1].attr("y",l),this.y=l},this.finalizeAction()}function Text(a,b,c,d,e,f,g,h,i){this.simplomat=i,this.view=h,this.font=a,this.fontSize=b,this.color=c,this.printColorId=d,this.textAnchor=g,this.horizontalAlignment="center",this.verticalAlignment="center",this.x=e,this.y=f,this.dragging=!1,this.textLines=new Array,this.addTextLine=function(a,b,c,d,e,f,g){if(this.simplomat.editMode||f){var h=d==null?this.fontSize:d,i=null;if(b!=null){var j=this.simplomat.spreadshirtAPI.getFontFamily(b);if(j!=null){var k=null;j.children("fonts").children("font").each(function(){var a=$(this);a.attr("id")==c&&(k=a)}),k!=null&&(i=new Font(c,b,k.children("name").text(),k.children("style").text(),k.children("weight").text(),k.children("minimalSize").text()))}}var l=null;if(e!=null){var m=this.simplomat.printType.getPrintColor(e);l=m.id}var n=this.view.boundary.x,o=this.view.boundary.y,p=this.view.getViewScale();if(typeof a=="string"){var q=new TextLine(a,i,d==null?null:d/p,e,l,n,o,"start",this,this.simplomat);this.textLines.push(q),this.dragging&&q.enableEdit()}else for(var r=0;r<a.length;r++){var q=new TextLine(a[r],i,d==null?null:d/p,e,l,n,o+r*2*h/p,"start",this,this.simplomat);this.textLines.push(q),this.dragging&&q.enableEdit()}g!==undefined&&g!==null&&g.apply(this,[]),this.simplomat.priceChangedCustomFunctions(),this.view!=this.simplomat.product.currentView&&this.hide()}},this.show=function(){for(var a=0,b=this.textLines.length;a<b;a++)this.textLines[a].show();this.simplomat.R.safari()},this.hide=function(){for(var a=0,b=this.textLines.length;a<b;a++)this.textLines[a].hide();this.simplomat.R.safari()},this.enableEdit=function(){this.dragging=!0;for(var a=0,b=this.textLines.length;a<b;a++)this.textLines[a].enableEdit()},this.disableEdit=function(){this.dragging=!1;for(var a=0,b=this.textLines.length;a<b;a++)this.textLines[a].disableEdit()},this.zoom=function(a){},this.rotate=function(a){},this.moveToPosition=function(a,b){var c=a-this.x,d=b-this.y;this.moveByDelta(c,d)},this.moveToRelativePosition=function(a,b){var c=this.getBoundary(),d=this.view.boundary.x+this.view.boundary.width*a/100-c.width/2,e=this.view.boundary.y+this.view.boundary.height*b/100-c.height/2;this.moveToPosition(d,e)},this.moveByDelta=function(a,b){for(var c=0,d=this.textLines.length;c<d;c++)this.textLines[c].moveByDelta(a,b);this.x+=a,this.y+=b},this.remove=function(){var a=this;this.view.texts=$.grep(this.view.texts,function(b){return b!=a});for(var b=0,c=this.textLines.length;b<c;b++)this.textLines[b].remove();this.simplomat.R.safari(),this.simplomat.priceChangedCustomFunctions()},this.finalizeAction=function(){var a=this.getBoundary(),b=a.x-this.view.boundary.x,c=this.view.boundary.x+this.view.boundary.width-(a.x+a.width),d=a.y-this.view.boundary.y,e=this.view.boundary.y+this.view.boundary.height-(a.y+a.height);b-10<c&&b+10>c?this.horizontalAlignment="center":b<c?this.horizontalAlignment="left":this.horizontalAlignment="right",d-10<e&&d+10>e?this.verticalAlignment="center":d<e?this.verticalAlignment="top":this.verticalAlignment="bottom",this.simplomat.R.safari()},this.getBoundary=function(a){var b=null,c=null,d=null,e=null;for(var f=0,g=this.textLines.length;f<g;f++){var h=this.textLines[f].getBoundary();if(b==null||h.x<b)b=h.x;if(c==null||h.y<c)c=h.y;if(d==null||h.x+h.width>d)d=h.x+h.width;if(e==null||h.y+h.height>e)e=h.y+h.height}var i=new Object;return i.x=b,i.y=c,i.width=d-b,i.height=e-c,i},this.detachFromCanvas=function(){},this.detach=function(){},this.changeView=function(a){var b=this.getBoundary(),c=this.view.boundary,d=a.boundary,e=b.x-c.x,f=c.x+c.width-(b.x+b.width),g=b.y-c.y,h=c.y+c.height-(b.y+b.height),i=d.width/c.width,j=d.height/c.height;this.view=a,this.view.texts.push(this),this.view!=this.view.product.currentView&&this.hide();var k=0,l=0;this.horizontalAlignment=="center"?k=d.width/2+d.x-b.width/2:this.horizontalAlignment=="left"?k=d.x+e*i:k=d.x+d.width-f*i-b.width,this.verticalAlignment=="center"?l=d.height/2+d.y-b.height/2:this.verticalAlignment=="top"?l=d.y+g*j:l=d.y+d.height-h*j-b.height;var m=(b.x-this.x)*i,n=(b.y-this.y)*j;this.moveToPosition(k-m,l-n)},this.simplomat.editMode?this.enableEdit():this.disableEdit(),this.finalizeAction()}function TextLine(a,b,c,d,e,f,g,h,i,j){this.text=i,this.simplomat=j,this.textString=a,this.font=b,this.fontSize=c,this.color=d,this.printColorId=e,this.textAnchor=h,this.x=f,this.y=g,this.textShapes=null,this.getFont=function(){return b==null?this.text.font:b},this.getFontSize=function(){return c==null?this.text.fontSize:c},this.getColor=function(){return d==null?this.text.color:d},this.getPrintColorId=function(){return e==null?this.text.printColorId:e},this.getTextAnchor=function(){return h==null?this.text.textAnchor:h},this.show=function(){for(var a=0,b=this.textShapes.length;a<b;a++)this.textShapes[a].show(),this.textShapes[a].animate({x:this.textShapes[a].attr("x")});this.simplomat.R.safari()},this.hide=function(){for(var a=0,b=this.textShapes.length;a<b;a++)this.textShapes[a].hide();this.simplomat.R.safari()},this.enableEdit=function(){this.text.dragging=!0;for(var a=0,b=this.textShapes.length;a<b;a++)this.textShapes[a].attr({cursor:"move"})},this.disableEdit=function(){this.text.dragging=!1;for(var a=0,b=this.textShapes.length;a<b;a++)this.textShapes[a].attr({cursor:"auto"})},this.moveToPosition=function(a,b){var c=a-this.x,d=b-this.y;this.moveByDelta(c,d)},this.moveToRelativePosition=function(a,b){var c=this.getBoundary(),d=this.text.view.boundary.x+this.text.view.boundary.width*a/100-c.width/2,e=this.text.view.boundary.y+this.text.view.boundary.height*b/100-c.height/2;this.moveToPosition(d,e)},this.moveByDelta=function(a,b){for(var c=0,d=this.textShapes.length;c<d;c++)this.textShapes[c].translate(a,b);this.x+=a,this.y+=b},this.getBoundary=function(a){var b=this.textShapes[0].getBBox(),c=this.textShapes[this.textShapes.length-1].getBBox(),d=new Object;return d.x=b.x,d.y=b.y,d.width=c.x+c.width-b.x,d.height=this.getFontSize(),d},this.remove=function(){for(var a=0,b=this.textShapes.length;a<b;a++)this.textShapes[a].remove()},this.textShapes=this.simplomat.R.print(this.x,this.y+this.getFontSize()/2,a,this.simplomat.R.getFont(this.getFont().name),this.getFontSize(),"left").attr("fill",this.getColor());for(var k=0,l=this.textShapes.length;k<l;k++)this.textShapes[k].text=this.text,this.textShapes[k].drag(function(a,b){if(this.text.dragging){var c=a-this.odx,d=b-this.ody;this.text.moveByDelta(c,d),this.odx=a,this.ody=b}},function(){this.text.dragging&&(this.ox=this.text.x,this.oy=this.text.y,this.odx=0,this.ody=0)},function(){this.text.dragging&&this.text.finalizeAction()});var m=this.getBoundary();this.textShapes.translate((this.x-m.x)*.9,0)}function PrintType(a,b,c,d,e,f){this.id=a,this.dpi=b,this.price=c,this.width=d,this.height=e,this.printColors=f,this.getPrintColor=function(a){for(var b=0;b<f.length;b++)if(f[b].hex===a)return f[b];return null},this.getPrintColorById=function(a){for(var b=0;b<f.length;b++)if(f[b].id===a)return f[b];return null}}function PrintColor(a,b,c){this.id=a,this.hex=b,this.price=c}function Font(a,b,c,d,e,f){this.id=a,this.familyId=b,this.name=c,this.style=d,this.weight=e,this.minimumFontSize=f}function PriceFormatter(a,b,c,d){this.format=a,this.decimalCount=b,this.centsSeparator=c,this.thousandsSeparator=d,this.formatPrice=function(a,b){a=""+a;var c="",d="0";a.indexOf(".")!=-1?(c=a.substring(a.indexOf(".")+1,a.length),d=a.substring(0,a.indexOf("."))):d=a;var e="",f=0;for(var g=d.length-1;g>=0;g--){var h=d.charAt(g);f++,f%3==0?e=this.thousandsSeparator+h+e:e=h+e}e.indexOf(0)==this.thousandsSeparator&&(e=e.substring(1,e.length)),e+=this.centsSeparator;for(var g=0;g<this.decimalCount;g++)g<c.length?e+=""+c.charAt(g):e+="0";var i=this.format;return i=i.replace("%",e),i=i.replace("$",b),i}}function Path(a){this.scaleFactor=a,this.path="",this.M=function(b,c){return this.path+="M"+b*a+","+c*a,this},this.L=function(b,c){return this.path+="L"+b*a+","+c*a,this},this.l=function(b,c){return this.path+="l"+b*a+","+c*a,this},this.C=function(b,c,d,e,f,g){return this.path+="C"+b*a+","+c*a+","+d*a+","+e*a+","+f*a+","+g*a,this},this.c=function(b,c,d,e,f,g){return this.path+="c"+b*a+","+c*a+","+d*a+","+e*a+","+f*a+","+g*a,this},this.Z=function(){return this.path+="Z",this}}function CustomSimplomat(){this.butt=new Array,this.colorButt=new Array,this.viewButt=new Array,this.sizeButt=new Array,this.priceLabel,this.buyButton,this.initCustomFunctions=function(){this.customCreateActionButtons(),this.customCreateColorButtons(),this.customCreateViewButtons(),this.customCreateSizeButtons(),this.customCreatePriceLabel(),this.customCreateBuyButton();for(var a=0;a<this.colorButt.length;a++)this.colorButt[a].show(),this.colorButt[a].animate({scale:1});for(var a=0;a<this.sizeButt.length;a++)this.sizeButt[a].show(),this.sizeButt[a].animate({scale:1});if(this.editAllowed){var b=this;this.product.image.click(this.product.image.click.andThen(function(){b.enableEdit()}))}this.initCallback!==undefined&&this.initCallback!==null&&this.initCallback()},this.customCreateActionButtons=function(){var a=this;this.butt=new Array,this.butt[0]=this.R.set(),this.butt[0].push(this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.path((new Path(this.relativeScaleFactor)).M(5,24).L(45,24).L(45,29).L(5,29).L(5,24).M(22.5,5).L(22.5,45).L(27.5,45).L(27.5,5).L(24,5).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({fill:a.boxFillColor,opacity:0})),this.butt[0].rotate(45);for(var b=0;b<this.butt.length;b++)this.butt[b].hide();this.butt[0].translate(10*this.relativeScaleFactor+this.offsetX,40*this.relativeScaleFactor+this.offsetY),this.butt[0][2].subject=this.butt[0][1],this.butt[0][2].simplomat=this,this.butt[0][2].click(function(){this.simplomat.disableEdit()}).mouseover(function(){this.subject.attr({fill:a.highlightColor})}).mouseout(function(){this.subject.attr({fill:a.textColor})}),this.butt[0].hide(),this.butt[1]=this.R.set(),this.butt[1].push(this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.path((new Path(this.relativeScaleFactor)).M(12.582,9.551).C(3.251,16.237,.921,29.021,7.08,38.564).l(-2.36,1.689).l(4.893,2.262).l(4.893,2.262).l(-0.568,-5.36).l(-0.567,-5.359).l(-2.365,1.694).c(-4.657,-7.375,-2.83,-17.185,4.352,-22.33).c(7.451,-5.338,17.817,-3.625,23.156,3.824).c(5.337,7.449,3.625,17.813,-3.821,23.152).l(2.857,3.988).c(9.617,-6.893,11.827,-20.277,4.935,-29.896).C(35.591,4.87,22.204,2.658,12.582,9.551).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({fill:a.boxFillColor,opacity:0})),this.butt[1].translate(10*this.relativeScaleFactor+this.offsetX,181*this.relativeScaleFactor+this.offsetY),this.butt[1][2].subject=this.butt[1][1],this.butt[1][2].simplomat=this,this.butt[1][2].click(function(){this.simplomat.product.currentView.currentDesign!=null&&this.simplomat.product.currentView.currentDesign.rotate(-15)}).mouseover(function(){this.subject.attr({fill:a.highlightColor})}).mouseout(function(){this.subject.attr({fill:a.textColor})}),this.butt[1].hide(),this.butt[2]=this.R.set(),this.butt[2].push(this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.path((new Path(this.relativeScaleFactor)).M(37.566,9.551).c(9.331,6.686,11.661,19.471,5.502,29.014).l(2.36,1.689).l(-4.893,2.262).l(-4.893,2.262).l(.568,-5.36).l(.567,-5.359).l(2.365,1.694).c(4.657,-7.375,2.83,-17.185,-4.352,-22.33).c(-7.451,-5.338,-17.817,-3.625,-23.156,3.824).C(6.3,24.695,8.012,35.06,15.458,40.398).l(-2.857,3.988).C(2.983,37.494,.773,24.109,7.666,14.49).C(14.558,4.87,27.944,2.658,37.566,9.551).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({fill:a.boxFillColor,opacity:0})),this.butt[2].translate(10*this.relativeScaleFactor+this.offsetX,245*this.relativeScaleFactor+this.offsetY),this.butt[2][2].subject=this.butt[2][1],this.butt[2][2].simplomat=this,this.butt[2][2].click(function(){this.simplomat.product.currentView.currentDesign!=null&&this.simplomat.product.currentView.currentDesign.rotate(15)}).mouseover(function(){this.subject.attr({fill:a.highlightColor})}).mouseout(function(){this.subject.attr({fill:a.textColor})}),this.butt[2].hide(),this.butt[3]=this.R.set(),this.butt[3].push(this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.path((new Path(this.relativeScaleFactor)).M(5,24).L(45,24).L(45,29).L(5,29).L(5,24).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({fill:a.boxFillColor,opacity:0})),this.butt[3].translate(10*this.relativeScaleFactor+this.offsetX,311*this.relativeScaleFactor+this.offsetY),this.butt[3][2].subject=this.butt[3][1],this.butt[3][2].simplomat=this,this.butt[3][2].click(function(){this.simplomat.product.currentView.currentDesign!=null&&this.simplomat.product.currentView.currentDesign.zoom(-0.1)}).mouseover(function(){this.subject.attr({fill:a.highlightColor})}).mouseout(function(){this.subject.attr({fill:a.textColor})}),this.butt[3].hide(),this.butt[4]=this.R.set(),this.butt[4].push(this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.path((new Path(this.relativeScaleFactor)).M(5,24).L(45,24).L(45,29).L(5,29).L(5,24).M(22.5,5).L(22.5,45).L(27.5,45).L(27.5,5).L(24,5).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({fill:a.boxFillColor,opacity:0})),this.butt[4].translate(10*this.relativeScaleFactor+this.offsetX,377*this.relativeScaleFactor+this.offsetY),this.butt[4][2].subject=this.butt[4][1],this.butt[4][2].simplomat=this,this.butt[4][2].click(function(){this.simplomat.product.currentView.currentDesign!=null&&this.simplomat.product.currentView.currentDesign.zoom(.1)}).mouseover(function(){this.subject.attr({fill:a.highlightColor})}).mouseout(function(){this.subject.attr({fill:a.textColor})}),this.butt[4].hide(),this.butt[5]=this.R.set(),this.butt[5].push(this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.path((new Path(this.relativeScaleFactor)).M(12.5,5).L(12.5,45).L(17.5,45).L(17.5,5).L(24,5).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.path((new Path(this.relativeScaleFactor)).M(22.5,5).L(22.5,45).L(27.5,45).L(27.5,5).L(24,5).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.path((new Path(this.relativeScaleFactor)).M(32.5,5).L(32.5,45).L(37.5,45).L(37.5,5).L(24,5).Z().path).attr({stroke:"none",fill:a.textColor}),this.R.circle(24.833*this.relativeScaleFactor,26.917*this.relativeScaleFactor,26.667*this.relativeScaleFactor).attr({fill:a.boxFillColor,opacity:0})),this.butt[5].translate(10*this.relativeScaleFactor+this.offsetX,443*this.relativeScaleFactor+this.offsetY),this.butt[5][4].subject1=this.butt[5][1],this.butt[5][4].subject2=this.butt[5][2],this.butt[5][4].subject3=this.butt[5][3],this.butt[5][4].simplomat=this,this.butt[5][4].click(function(){this.simplomat.product.currentView.currentDesign!=null&&this.simplomat.product.currentView.currentDesign.remove()}).mouseover(function(){this.subject1.attr({fill:a.highlightColor}),this.subject2.attr({fill:a.highlightColor}),this.subject3.attr({fill:a.highlightColor})}).mouseout(function(){this.subject1.attr({fill:a.textColor}),this.subject2.attr({fill:a.textColor}),this.subject3.attr({fill:a.textColor})}),this.butt[5].hide()},this.customCreateColorButtons=function(){var a=this;this.colorButt=new Array;var b=this.colorButt,c=0,d=0;for(var e=0;e<this.product.appearances.length;e++){var f=this.product.appearances[e];this.colorButt[e]=this.R.set(),this.colorButt[e].push(this.R.image(f.imageUrl,0,0,30*this.relativeScaleFactor,30*this.relativeScaleFactor).attr({cursor:"pointer"}),this.R.rect(0,0,30*this.relativeScaleFactor,30*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,"stroke-width":2})),this.colorButt[e].hide(),this.colorButt[e].translate((620+d*35)*this.relativeScaleFactor+this.offsetX,(400+c*35)*this.relativeScaleFactor+this.offsetY),this.colorButt[e][0].product=this.product,this.colorButt[e][0].myColor=""+f.id,this.colorButt[e][0].subject=this.colorButt[e][1],this.colorButt[e][0].click(function(){for(var c=0;c<b.length;c++)b[c][0].subject.attr({stroke:a.boxStrokeColor});this.subject.strokeColor=a.selectionColor,this.subject.attr({stroke:this.subject.strokeColor}),this.product.changeAppearance(this.myColor)}).mouseover(function(){this.subject.strokeColor=this.subject.attr("stroke"),this.subject.attr({stroke:a.highlightColor})}).mouseout(function(){this.subject.attr({stroke:this.subject.strokeColor})}),this.product.appearanceId==this.product.appearances[e].id&&this.colorButt[e][1].attr({stroke:a.selectionColor}),d++,e+1>0&&(e+1)%5==0&&(c++,d=0)}},this.customCreateViewButtons=function(){var a=this;this.viewButt=new Array;var b=this.viewButt,c=0,d=0;for(var e=0;e<this.product.views.length;e++){var f=this.product.views[e];this.viewButt[e]=this.R.set(),this.viewButt[e].push(this.R.rect(0,0,50*this.relativeScaleFactor,50*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.image(this.product.createViewImageUrl(f.id,this.product.appearanceId,50),0,0,50*this.relativeScaleFactor,50*this.relativeScaleFactor).attr({cursor:"pointer"})),this.viewButt[e].hide(),this.viewButt[e].translate((10+d*55)*this.relativeScaleFactor+this.offsetX,(600+c*55)*this.relativeScaleFactor+this.offsetY),this.viewButt[e][1].product=this.product,this.viewButt[e][1].myView=""+f.id,this.viewButt[e][1].subject=this.viewButt[e][0],this.viewButt[e][1].click(function(){for(var c=0;c<b.length;c++)b[c][1].subject.attr({stroke:a.boxStrokeColor});this.subject.strokeColor=a.selectionColor,this.subject.attr({stroke:this.subject.strokeColor}),this.product.changeView(this.myView)}).mouseover(function(){this.subject.strokeColor=this.subject.attr("stroke"),this.subject.attr({stroke:a.highlightColor})}).mouseout(function(){this.subject.attr({stroke:this.subject.strokeColor})}),this.product.viewId==this.product.views[e].id&&this.viewButt[e][0].attr({stroke:a.selectionColor}),d++,e+1>0&&(e+1)%3==0&&(c++,d=0)}},this.customCreateSizeButtons=function(){var a=this;this.sizeButt=new Array;var b=this.sizeButt,c=0,d=0;for(var e=0;e<this.product.sizes.length;e++){var f=this.product.sizes[e];this.sizeButt[e]=this.R.set(),this.sizeButt[e].push(this.R.rect(0,0,53*this.relativeScaleFactor,30*this.relativeScaleFactor).attr({stroke:a.boxStrokeColor,fill:a.boxFillColor,"fill-opacity":.5,"stroke-width":2,cursor:"pointer"}),this.R.text(0,0,f.name).attr({"font-size":Math.round(17*this.relativeScaleFactor),"font-weight":"bold",cursor:"pointer"}));var g=this.sizeButt[e][1].getBBox();this.sizeButt[e][1].attr({x:(this.sizeButt[e][0].attr("width")-g.width)/2+g.width/2,y:(this.sizeButt[e][0].attr("height")-g.height)/2+g.height/2}),this.sizeButt[e][1].attr({fill:a.textColor}),this.sizeButt[e].hide(),this.sizeButt[e].translate((620+d*58)*this.relativeScaleFactor+this.offsetX,(600+c*35)*this.relativeScaleFactor+this.offsetY),this.sizeButt[e][1].product=this.product,this.sizeButt[e][1].size=""+f.id,this.sizeButt[e][1].subject=this.sizeButt[e][0],this.sizeButt[e][1].clickable=!1,this.sizeButt[e][1].click(function(){if(this.clickable){for(var c=0;c<b.length;c++)b[c][1].subject.attr({stroke:a.boxStrokeColor}),b[c][1].attr({fill:a.textColor});this.subject.strokeColor=a.selectionColor,this.fillColor=a.selectionColor,this.attr({fill:this.fillColor}),this.subject.attr({stroke:this.subject.strokeColor}),this.product.changeSize(this.size)}}).mouseover(function(){this.clickable&&(this.subject.strokeColor=this.subject.attr("stroke"),this.fillColor=this.attr("fill"),this.attr({fill:a.highlightColor}),this.subject.attr({stroke:a.highlightColor}))}).mouseout(function(){this.clickable&&(this.attr({fill:a.textColor}),this.attr({fill:this.fillColor}),this.subject.attr({stroke:this.subject.strokeColor}))}),this.sizeButt[e][0].product=this.product,this.sizeButt[e][0].size=""+f.id,this.sizeButt[e][0].subject=this.sizeButt[e][1],this.sizeButt[e][0].click(function(){if(this.subject.clickable){for(var c=0;c<b.length;c++)b[c][1].subject.attr({stroke:a.boxStrokeColor}),b[c][1].attr({fill:a.textColor});this.strokeColor=a.selectionColor,this.subject.fillColor=a.selectionColor,this.subject.attr({fill:this.subject.fillColor}),this.attr({stroke:this.strokeColor}),this.product.changeSize(this.size)}}).mouseover(function(){this.subject.clickable&&(this.strokeColor=this.attr("stroke"),this.subject.fillColor=this.subject.attr("fill"),this.subject.attr({fill:a.highlightColor}),this.attr({stroke:a.highlightColor}))}).mouseout(function(){this.subject.clickable&&(this.subject.attr({fill:a.textColor}),this.subject.attr({fill:this.subject.fillColor}),this.attr({stroke:this.strokeColor}))}),this.product.sizeId==""+this.product.sizes[e].id&&(this.sizeButt[e][1].attr({fill:a.selectionColor}),this.sizeButt[e][0].attr({stroke:a.selectionColor})),d++,e+1>0&&(e+1)%3==0&&(c++,d=0)}this.updateSizeButtons()},this.updateSizeButtons=function(){var a=this;for(var b=0;b<this.product.sizes.length;b++){var c=this.product.getAvailableSizes(),d=!1;for(var e=0;e<c.length;e++)if(c[e]==this.product.sizes[b].id){d=!0;break}d?(this.sizeButt[b][1].clickable=!0,this.sizeButt[b][0].attr({fill:a.boxFillColor})):(this.sizeButt[b][1].clickable=!1,this.sizeButt[b][0].attr({fill:a.boxFillDeselectedColor}))}},this.customCreatePriceLabel=function(){this.priceLabel!=null&&this.priceLabel.remove(),this.priceLabel=this.R.text(0,0,""+this.product.getFormatedPrice()).attr({"font-size":Math.round(25*this.relativeScaleFactor),"font-weight":"bold",fill:"#fff"});var a=this.priceLabel.getBBox();this.priceLabel.translate((780-a.width/2)*this.relativeScaleFactor+this.offsetX,710*this.relativeScaleFactor+this.offsetY)},this.customCreateBuyButton=function(){var a=this;this.buyButton=this.R.set(),this.buyButton.push(this.R.rect(0,0,170*this.relativeScaleFactor,30*this.relativeScaleFactor).attr({stroke:this.boxStrokeColor,fill:this.boxFillColor,"fill-opacity":.5,"stroke-width":2}),this.R.text(0,0,"Buy now").attr({"font-size":Math.round(17*this.relativeScaleFactor),stroke:"none",fill:this.textColor,"font-weight":"bold"}));var b=this.buyButton[1].getBBox();this.buyButton[1].attr({x:(this.buyButton[0].attr("width")-b.width)/2+b.width/2,y:(this.buyButton[0].attr("height")-b.height)/2+b.height/2}),this.buyButton.translate(620*this.relativeScaleFactor+this.offsetX,755*this.relativeScaleFactor+this.offsetY),this.buyButton[1].subject=this.buyButton[0],this.buyButton[1].clickable=!1,this.buyButton[1].simplomat=this,this.buyNowHook=null,this.buyHandler=function(){if(this.simplomat.buyNowHook!==null){this.simplomat.buyNowHook(function(){a.createProductAndCheckout()});return}this.clickable&&this.simplomat.createProductAndCheckout()},this.buyButton[1].click(this.buyHandler).mouseover(function(){this.clickable&&(this.subject.strokeColor=this.subject.attr("stroke"),this.fillColor=this.attr("fill"),this.attr({fill:a.highlightColor}),this.subject.attr({stroke:a.highlightColor}))}).mouseout(function(){this.clickable&&(this.attr({fill:a.textColor}),this.attr({fill:this.fillColor}),this.subject.attr({stroke:this.subject.strokeColor}))}),this.buyButton[0].subject=this.buyButton[1],this.buyButton[0].simplomat=this,this.buyButton[0].click(this.buyHandler).mouseover(function(){this.subject.clickable&&(this.strokeColor=this.attr("stroke"),this.subject.fillColor=this.subject.attr("fill"),this.subject.attr({fill:a.highlightColor}),this.attr({stroke:a.highlightColor}))}).mouseout(function(){this.subject.clickable&&(this.subject.attr({fill:a.textColor}),this.subject.attr({fill:this.subject.fillColor}),this.attr({stroke:this.strokeColor}))})},this.enableEditCustomFunctions=function(){for(var a=0;a<this.butt.length;a++)this.butt[a].show(),this.butt[a].animate({scale:1});for(var a=0;a<this.viewButt.length;a++)this.viewButt[a].show(),this.viewButt[a].animate({scale:1});this.R.safari()},this.disableEditCustomFunctions=function(){for(var a=0;a<this.butt.length;a++)this.butt[a].hide();for(var a=0;a<this.viewButt.length;a++)this.viewButt[a].hide();this.R.safari()},this.viewChangedCustomFunctions=function(){},this.productTypeChangedCustomFunctions=function(){for(var a=0;a<this.viewButt.length;a++)this.viewButt[a].remove();for(var a=0;a<this.colorButt.length;a++)this.colorButt[a].remove();for(var a=0;a<this.sizeButt.length;a++)this.sizeButt[a].remove();this.customCreateColorButtons(),this.customCreateViewButtons(),this.customCreateSizeButtons();for(var a=0;a<this.colorButt
.length;a++)this.colorButt[a].show(),this.colorButt[a].animate({scale:1});for(var a=0;a<this.sizeButt.length;a++)this.sizeButt[a].show(),this.sizeButt[a].animate({scale:1});this.editMode?this.enableEditCustomFunctions():this.disableEditCustomFunctions(),this.appearanceChangedCustomFunctions(),this.sizeChangedCustomFunctions(),this.priceChangedCustomFunctions(),this.R.safari()},this.sizeChangedCustomFunctions=function(){this.product.sizeId==null?(this.buyButton[1].clickable=!1,this.buyButton[0].attr({cursor:"default"}),this.buyButton[1].attr({cursor:"default"})):(this.buyButton[1].clickable=!0,this.buyButton[0].attr({cursor:"pointer"}),this.buyButton[1].attr({cursor:"pointer"}))},this.appearanceChangedCustomFunctions=function(){for(var a=0;a<this.viewButt.length;a++)this.viewButt[a][1].attr({src:this.product.createViewImageUrl(this.viewButt[a][1].myView,this.product.appearanceId,50)});this.updateSizeButtons()},this.priceChangedCustomFunctions=function(){this.customCreatePriceLabel()}}function f_scrollTop(){return f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}function f_filterResults(a,b,c){var d=a?a:0;return b&&(!d||d>b)&&(d=b),c&&(!d||d>c)?c:d}function checkBoundaries(a){var b=!0,c=$.merge([],a.product.currentView.designs);return c=$.merge(c,a.product.currentView.texts),$.each(c,function(c,d){var e=d.getBoundary(),f=a.product.currentView.boundary;if(e.x<f.x)return b=!1,!1;if(e.y<f.y)return b=!1,!1;if(e.x+e.width>f.x+f.width)return b=!1,!1;if(e.y+e.height>f.y+f.height)return b=!1,!1}),b}var Utf8={encode:function(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(d&63|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(d&63|128))}return b},decode:function(a){var b="",c=0,d=c1=c2=0;while(c<a.length)d=a.charCodeAt(c),d<128?(b+=String.fromCharCode(d),c++):d>191&&d<224?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}},PixelMMConverter={mmToPixel:function(a,b){return a*(b!=null?b:120)/25.4},pixelToMM:function(a,b){return a*25.4/(b!=null?b:120)}},Rounder={round:function(a){return parseInt(a*100)/100}};Function.prototype.andThen=function(a){var b=this;return function(){b(),a()}},CustomSimplomat.prototype=new Simplomat,jQuery.imageMagnify={dsettings:{magnifyby:3,duration:500,imgopacity:.2,callback:null,closeOnClick:!0,id:null},zIndexcounter:100,refreshoffsets:function(a,b,c){var d=b.offset(),e={x:a.scrollLeft(),y:a.scrollTop(),w:a.width(),h:a.height()};c.attrs.x=d.left,c.attrs.y=d.top,c.newattrs.x=e.x+e.w/2-c.newattrs.w/2,c.newattrs.y=e.y+e.h/2-c.newattrs.h/2,c.newattrs.x<e.x+5?c.newattrs.x=e.x+5:c.newattrs.x+c.newattrs.w>e.x+e.w&&(c.newattrs.x=e.x+5),c.newattrs.y<e.y+5&&(c.newattrs.y=e.y+5)},magnify:function(a,b,c){var d={},d=jQuery.extend(d,this.dsettings,c),e=c.thumbdimensions?{w:c.thumbdimensions[0],h:c.thumbdimensions[1]}:{w:b.outerWidth(),h:b.outerHeight()},f={};f.w=d.magnifyto?d.magnifyto:Math.round(e.w*d.magnifyby),f.h=d.magnifyto?Math.round(e.h*f.w/e.w):Math.round(e.h*d.magnifyby),b.data("imgshell")&&(b.data("imgshell").$clone.remove(),b.css({opacity:1}).unbind("click.magnify"));var g=b.clone().css({position:"absolute",left:0,top:0,visibility:"hidden"}).appendTo(document.body);d.closeOnClick&&$clonse.css({cursor:"pointer"}),d.id&&g.attr("id",d.id),g.data("$relatedtarget",b),b.data("imgshell",{$clone:g,attrs:e,newattrs:f}),b.bind("click.magnify",function(b){var c=a(this).css({opacity:d.imgopacity}),e=c.data("imgshell");jQuery.imageMagnify.refreshoffsets(a(window),c,e);var f=e.$clone;f.stop().css({zIndex:++jQuery.imageMagnify.zIndexcounter,left:e.attrs.x,top:e.attrs.y,width:e.attrs.w,height:e.attrs.h,opacity:0,visibility:"visible",display:"block"}).animate({opacity:1,left:e.newattrs.x,top:e.newattrs.y,width:e.newattrs.w,height:e.newattrs.h},d.duration,function(){d.callback!==null&&d.callback(f)})}),d.closeOnClick&&g.click(function(b){var c=a(this),e=c.data("$relatedtarget").data("imgshell");jQuery.imageMagnify.refreshoffsets(a(window),c.data("$relatedtarget"),e),c.stop().animate({opacity:0,left:e.attrs.x,top:e.attrs.y,width:e.attrs.w,height:e.attrs.h},d.duration,function(){c.hide(),c.data("$relatedtarget").css({opacity:1})})})}},jQuery.fn.imageMagnify=function(a){var b=jQuery;return this.each(function(){var c=b(this);if(this.tagName!="IMG")return!0;parseInt(c.css("width"))>0&&parseInt(c.css("height"))>0||a.thumbdimensions?jQuery.imageMagnify.magnify(b,c,a):this.complete?jQuery.imageMagnify.magnify(b,c,a):b(this).bind("load",function(){jQuery.imageMagnify.magnify(b,c,a)})})},jQuery.fn.applyMagnifier=function(a){var b=jQuery;return this.each(function(){var a=b(this);if(this.tagName!="IMG")return!0})},jQuery(document).ready(function(a){var b=a(".magnify");b.each(function(b){var c=a(this),d={};c.attr("data-magnifyto")&&(d.magnifyto=parseFloat(c.attr("data-magnifyto"))),c.attr("data-magnifyby")&&(d.magnifyby=parseFloat(c.attr("data-magnifyby"))),c.attr("data-magnifyduration")&&(d.duration=parseInt(c.attr("data-magnifyduration"))),c.imageMagnify(d)});var c=a('a[rel^="magnify["]');c.each(function(b){var c=a(this),d=c.attr("rel").match(/\[.+\]/)[0].replace(/[\[\]']/g,"");c.data("magnifyimageid",d),c.click(function(b){a("#"+a(this).data("magnifyimageid")).trigger("click.magnify"),b.preventDefault()})})}),jQuery.Semaphore=function(a){var b=this;b.value=typeof a=="undefined"?1:a,b.callbacks=new Array,b.link=function(a){return b.value>0?a():b.callbacks.push(a),b},b.acquire=function(){return b.value=b.value-1,b},b.release=function(){return b.value=b.value+1,b.value>0&&($.each(b.callbacks,function(a,b){b()}),b.callbacks.length=0),b}},jQuery.dragToShirt=new function(){var a=this;a.init=function(b){b=jQuery.extend({productTypes:["175"],targetSize:100,designerSize:500,overlayZ:1e3,shopId:null,platform:"na",showName:!0,proxy:"/proxy.php"},b);var c=new jQuery.Semaphore,d=$('<ul id="dts-targets"></ul>').css({position:"absolute","max-width":900}).hide().appendTo("body");$.each(b.productTypes,function(a,c){$("<li></li>").attr("id","dts-producttype"+c).appendTo(d).css({width:b.targetSize})});var e=new SpreadshirtAPI(b.platform,b.shopId,b.proxy);e.getShop(b.shopId,function(d){e.shop=d,e.getProductTypes(0,1e3,!1,function(c){$.each(b.productTypes,function(d,e){var f=c.find("productType[id="+e+"]"),g=f.children("name").text(),h=f.children("resources").children("resource").attr("xlink:href"),i=h.split("/").pop();h=h+",width="+b.designerSize+",height="+b.designerSize;var j=$("<img />").attr("src",h).css({width:b.targetSize,height:b.targetSize}).data("productType",e).data("appearanceId",i).data("name",g);j.appendTo("#dts-producttype"+e),a.makeDroppable(j)})}),e.getCurrency(d.children("currency").attr("id"),c.acquire().release),e.getCountry(d.children("country").attr("id"),c.acquire().release),e.getPrintType("17",c.acquire().release),c.link(function(){e.currency=e.getCurrency(e.shop.children("currency").attr("id")),e.country=e.getCountry(e.shop.children("country").attr("id"))})}),$('<span id="dts-name">').hide().appendTo("body").css({position:"absolute",top:10,width:"100%","text-align":"center",color:"white","z-index":b.overlayZ+1}),$(document).keyup(function(a){a.keyCode!=27}),a.config=b,a.initSemaphore=c,a.api=e,a.dragging=!1,a.dropped=!1},a.showDesigner=function(b,c,d,e){var f=a.config,g=f.overlayZ,h=new CustomSimplomat;h.defaultSize=f.designerSize,h.relativeScaleFactor=.625,h.initCallback=function(){var a=$("#dts-magnify").position();h.buyButton[0].clickable=!0,h.buyButton[1].clickable=!0,h.buyButton[0].attr({cursor:"pointer"}),h.buyButton[1].attr({cursor:"pointer"}),h.buyNowHook=function(b){if(h.product.sizeId===undefined||h.product.sizeId===null)return alert("Please select a size!"),!1;if(!checkBoundaries(h))return alert("One or more elements are out of bounds!"),!1;var c=a.top-30<10?10:a.top-30;return $('<span id="dts-message">Creating product, please wait...</span>').css({position:"absolute",top:c,width:"100%","text-align":"center",color:"white","z-index":f.overlayZ+1}).appendTo("body").show(0,function(){setTimeout(b,10)}),!0},$("#dts-overlay").one("click",function(){i.remove(),$("#dts-name").hide(),$("#dts-overlay").remove(),$("#dts-close").remove(),$("#dts-message").remove()}),$('<a id="dts-close" href="#">close [x]</a>').appendTo("body").css({position:"absolute",top:a.top,left:a.left+f.designerSize-50,"text-decoration":"none",color:"white","font-size":"11px","font-style":"normal","font-weight":"bold","z-index":g+2}).click(function(){$("#dts-overlay").click()}),$("#dts-designer").css({"z-index":g+1,top:a.top,left:a.left}).show(100,function(){$("#dts-magnify").remove()}),$("#dts-message").fadeOut("slow")};var i=$('<div id="dts-designer"></div>').css({width:f.designerSize,height:f.designerSize,position:"absolute",top:30}).hide().appendTo("body");try{h.init("dts-designer",f.designerSize,a.api,!0,!0,d,b,c,null,"digi",0,0,f.designerSize,f.designerSize)}catch(j){var e=$("#dts-magnify").position();$('<div id="dts-error">Product type ('+b+") is not compatible</div>").css({color:"white",position:"absolute","z-index":g+3,top:e.top+f.designerSize/2-30,width:"100%","text-align":"center"}).appendTo("body");var k=function(){$("#dts-magnify").remove(),$("#dts-error").remove(),$("#dts-overlay").remove(),$("#dts-name").hide(),i.remove(),$("#dts-message").remove()};$("#dts-magnify").one("click",k),$("#dts-overlay").one("click",k)}},a.makeDroppable=function(b){var c=a.config,d=c.overlayZ;b.droppable({tolerance:"pointer",over:function(){c.showName&&($("#dts-name").text($(this).data("name")),$("#dts-name").show())},out:function(){$("#dts-name").hide()},drop:function(b,e){$("#dts-name").hide(),a.dropped=!0;var f=$(this).data("productType"),g=$(this).data("appearanceId"),h=$(this),i=$(e.draggable),j=i.attr("dragtoshirt")||i.attr("src");jQuery.imageMagnify.zIndexcounter=d+2,h.imageMagnify({magnifyto:c.designerSize,magnifyduration:1e3,id:"dts-magnify",closeOnClick:!1,callback:function(b){var d=$("#dts-magnify").position(),e=d.top-30<10?10:d.top-30;$('<span id="dts-message">Loading designer, please wait...</span>').css({position:"absolute",top:e,width:"100%","text-align":"center",color:"white","z-index":c.overlayZ+1}).appendTo("body").show(0,function(){setTimeout(function(){a.showDesigner(f,g,j,d)},0)})}}).click()}})},a.makeDraggable=function(b){var c=$("#dts-targets"),d=a.config.overlayZ;b.draggable({helper:function(){return $("<div>").attr("id","helper").html("<span>Drag To Shirt</span><img id='thumb' src='"+$(this).attr("src")+"'>").appendTo("body")},iframeFix:!0,cursor:"pointer",cursorAt:{left:-10,top:20},zIndex:d+2,start:function(){$("<div>").attr("id","dts-overlay").css("opacity",.9).css("z-index",d).appendTo("body").mouseup(function(){a.dropped||$(this).remove()}),a.dragging=!0,a.dropped=!1;var b=c.width();c.css("left",$("body").width()/2-b/2).css("top",f_scrollTop()+20).css("z-index",d+1).slideDown(200),$("#dts-name").css("top",c.position().top-10)},stop:function(){c.slideUp(null,function(){c.find("img").css({opacity:1}),setTimeout(function(){a.dropped||$("#dts-overlay").remove()},0)}),a.dragging=!1}})},a.addTooltip=function(b){b.mousemove(function(b){if(a.dragging){$("#dts-tip").remove();return}$("#dts-tip").length===0?$("<div>").html("<span>Drag this image to create shirt</span><span class='arrow'></span>").attr("id","dts-tip").css({left:b.pageX+30,top:b.pageY-16}).appendTo("body").fadeIn(800):$("#dts-tip").css({left:b.pageX+30,top:b.pageY-16})}),b.mouseleave(function(){$("#dts-tip").remove()})}},jQuery.fn.dragToShirt=function(){jQuery.dragToShirt.addTooltip($(this)),jQuery.dragToShirt.makeDraggable($(this))};